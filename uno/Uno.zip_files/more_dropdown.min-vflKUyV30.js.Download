define(["require","exports","tslib","react","external/lodash","external/react-redux","spectrum/popover","modules/clean/previews/data/selectors","modules/clean/previews/util","modules/clean/react/file_action_button_type","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/data/selectors","file-viewer/core","modules/clean/react/file_viewer/files2_utils","modules/clean/react/file_viewer/utils","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_viewer/more_dropdown/views","modules/clean/react/size_class/constants","modules/clean/file_store/utils","modules/clean/react/title_bar/overflow_menu","modules/core/browser","modules/core/i18n","modules/clean/react/paper/utils","react-dom","modules/clean/react/paper/open_in_paper_callout_loader","modules/clean/react/paper/open_in_paper_button","modules/clean/react/file_viewer/data/actions","modules/clean/previews/util","modules/clean/react/extensions/download_intercept","modules/clean/react/extensions/data/action_creators","modules/clean/react/watermarking/callout","modules/clean/react/watermarking/utils"],function(e,t,o,r,n,i,a,l,s,c,p,u,d,m,f,_,g,h,v,w,C,k,A,I,M,y,O,S,b,F,P,E,D,B){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r=o.__importDefault(r),n=o.__importStar(n),s=o.__importStar(s),y=o.__importStar(y);var R=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state=t.getStateFromRegistry(),t.onRegistryUpdate=function(){t.setState(t.getStateFromRegistry())},t.handleDownloadClick=function(e){e.preventDefault(),b.download(t.props.file);var o=t.props.setInDownloadInterceptFlow;if(t.props.extensionsConfig&&C.isBrowseFile(t.props.file)&&t.props.user&&o&&t.props.sizeClass===w.SizeClass.Large){var r=function(){o({inDownloadInterceptFlow:!0})};P.onDownloadFile(t.props.extensionsConfig,t.props.user,t.props.file.ext,r)}return p.logUserAction(u.UserAction.Download,u.UserActionContext.TitleBarMore)},t.handleRemoveLinkClick=function(e){e.preventDefault(),t.props.onRemoveShareLink&&(t.props.onRemoveShareLink(),p.logUserAction(u.UserAction.RemoveLink,u.UserActionContext.TitleBarMore))},t.handlePreviousVersionClick=function(e){if(e.preventDefault(),!t.props.user)throw new Error("User not specified");return s.redirectToVersionHistory(t.props.file,t.props.user),p.logUserAction(u.UserAction.ViewRevisions,u.UserActionContext.TitleBarMore)},t.handleSignInClick=function(e){e.preventDefault(),p.logUserAction(u.UserAction.SignIn,u.UserActionContext.TitleBarMore),A.redirect(_.getSharedLinkLoginUrl())},t.handleWatermarkingModeToggle=function(e){return o.__awaiter(t,void 0,void 0,function(){var t,r,n;return o.__generator(this,function(o){return e.preventDefault(),t=this.props,r=t.mode,(n=t.changeMode)?(r===m.FileViewerMode.Watermarking?(p.logUserAction(u.UserAction.WatermarkCancel,u.UserActionContext.TitleBarMore),n(m.FileViewerMode.Default)):(p.logUserAction(u.UserAction.WatermarkEnable,u.UserActionContext.TitleBarMore),n(m.FileViewerMode.Watermarking)),[2]):[2]})})},t.handleOpenInPaperClick=function(e){e.preventDefault();var o={file:t.props.file,user:t.props.user,sharedLink:t.props.sharedLink,fromModal:!1};M.openFileInPaper(o)},t.handleClick=function(){t.setState({hasBeenClicked:!0})},t}return o.__extends(t,e),t.prototype.componentDidMount=function(){this.removeRegistryListener=h.moreOptionRegistry.addListener(this.onRegistryUpdate)},t.prototype.componentWillUnmount=function(){this.removeRegistryListener()},t.prototype.getStateFromRegistry=function(){var e=this.state||{hasBeenClicked:!1,registeredItems:[]},t=o.__assign({},e,{registeredItems:h.moreOptionRegistry.getOptionItems()}),r=this.getOptionItemsContent(t.registeredItems),i=this.getOptionItemsContent(e.registeredItems);return n.isEqual(r,i)||(t.hasBeenClicked=!1),t},t.prototype.getOptionItemsContent=function(e){var t=this;return e.reduce(function(e,o){return o instanceof g.MoreOption?e.push(t.getMoreOptionContent(o)):e=e.concat(o.options.map(t.getMoreOptionContent)),e},[])},t.prototype.getMoreOptionContent=function(e){return c.getFileActionButtonText(e.fileActionButtonType)},t.prototype.getPopoverContent=function(){var e=this.props,t=e.allowRemoveLink,o=e.isPrivate,n=e.mode,i=e.onRemoveShareLink,l=e.renderSignIn,s=e.shareDownloadOptions,p=e.sizeClass,u=e.showOpenInPaper,d=e.file,_=e.user,g=[],h=p===w.SizeClass.Small,C=p===w.SizeClass.Medium,A=p===w.SizeClass.Large;if(o&&C&&g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__share",key:"more-button__share",onSelect:this.props.onClickShareLink},c.getFileActionButtonText(c.FileActionButtonType.SHARE))),null!=i&&t&&!h&&g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__remove",key:"more-button__remove",onSelect:this.handleRemoveLinkClick},c.getFileActionButtonText(c.FileActionButtonType.REMOVE_LINK))),o&&!F.isCloudDocPreview(d)&&g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__download",key:"more-button__download",onSelect:this.handleDownloadClick},c.getFileActionButtonText(c.FileActionButtonType.DOWNLOAD))),s&&!F.isCloudDocPreview(d))for(var M=0,y=s;M<y.length;M++){var O=y[M];if(!O.isDisabled){var b="more-button-sl__"+O.userAction;g.push(r.default.createElement(T,{handler:O.handler,key:b,text:O.text,userAction:O.userAction}))}}if(o&&!h&&g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__version-history",key:"more-button__version-history",onSelect:this.handlePreviousVersionClick},c.getFileActionButtonText(c.FileActionButtonType.PREVIOUS_VERSIONS))),A&&!F.isCloudDocPreview(d)){var P=v.getPopoverOrMobileItemsForMoreOptions(this.state.registeredItems);g=g.concat(P)}if(!f.isFiles2WatermarkingEnabled(_)&&B.allowWatermark(d,_)){g.push(r.default.createElement(a.PopoverContentSeparator,{key:"more_button__separator2"}));var E=n===m.FileViewerMode.Watermarking?c.FileActionButtonType.REMOVE_WATERMARKING:c.FileActionButtonType.ENABLE_WATERMARKING;g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__watermarking-toggle",key:"more-button__watermarking-toggle",onSelect:this.handleWatermarkingModeToggle},c.getFileActionButtonText(E)))}return l&&g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__sign-in",key:"more-button__sign-in",onSelect:this.handleSignInClick},F.isCloudDocPreview(d)?I._("Edit now"):I._("Sign in"))),u&&(A&&g.length&&this.state.registeredItems.length&&g.push(r.default.createElement(a.PopoverContentSeparator,{key:"more_button__separator2"})),g.push(r.default.createElement(k.PopoverOrMobileItem,{className:"more-button__open-in-paper",key:"more-button__open-in-paper",onSelect:this.handleOpenInPaperClick},r.default.createElement(S.OpenInPaperButtonInMoreDropdown,{file:d,handleOpenInPaperClick:this.handleOpenInPaperClick,sizeClass:p})))),g},t.prototype.render=function(){var e=this,t=this.props,o=t.file,n=t.sizeClass,i=t.showOpenInPaper,a=t.user,l=this.state.hasBeenClicked;return r.default.createElement("div",{ref:function(t){e.ref=y.findDOMNode(t)},onClick:this.handleClick},r.default.createElement(k.OverflowMenu,{contentWrapperClassName:"react-file-viewer-dropdown",hideOnDisabled:F.isCloudDocPreview(o)},this.getPopoverContent()),i?r.default.createElement(O.OpenInPaperCalloutLoader,{file:o,parentHasBeenClicked:l,sizeClass:n,targetNode:this.ref,user:a,variant:M.OpenInPaperButtonVariant.Ellipsis}):null,!f.isFiles2WatermarkingEnabled(a)&&B.allowWatermark(o,a)?r.default.createElement(D.WatermarkingCallout,{targetNode:this.ref,parentHasBeenClicked:l}):null)},t})(r.default.Component);t._MoreDropdown=R;var x=function(e){var t=d.getActiveFile(e);return{isFileRendered:d.getRenderStatusForCurrentFile(e)===u.PreviewRenderStatus.Succeeded,mode:d.getMode(e),previewApiData:l.getApiDataForFile(e,t)}},U=i.connect(x,{changeMode:b.changeMode,setInDownloadInterceptFlow:E.setInDownloadInterceptFlow})(R);t.MoreDropdown=U;var T=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handleClick=function(){var e=t.props,o=e.handler,r=e.userAction;p.logUserAction(r,u.UserActionContext.TitleBarMore),o()},t}return o.__extends(t,e),t.prototype.render=function(){var e=this.props.text;return r.default.createElement(k.PopoverOrMobileItem,{onSelect:this.handleClick},e)},t})(r.default.PureComponent)});
//# sourceMappingURL=more_dropdown.min.js-vflAqHQCH.map