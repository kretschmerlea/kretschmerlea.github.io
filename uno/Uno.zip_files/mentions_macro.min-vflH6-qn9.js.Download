define(["require","exports","tslib","spectrum_comments/comment_editor/core/class_decorators","spectrum_comments/comment_editor/layers/scaffold","draft-js","spectrum_comments/comment_editor/layers/macro","spectrum_comments/comment_editor/components/mention_suggestions_list_component","spectrum_comments/comment_editor/draft_utils"],function(t,e,n,o,i,r,s,a,u){"use strict";function c(t){var e=t.editorState,n=t.identifier,o=t.blockKey,i=t.start,s=t.end,a=t.text,c={identifier:n,type:"email"},g=e.getCurrentContent(),p=g.createEntity("mention","IMMUTABLE",c),m=p.getLastCreatedEntityKey(),l=u.replaceText(p,o,i,s,"@"+a,m);return{editorState:u.replaceContent(e,r.Modifier.insertText(l,l.getSelectionAfter()," ")),mentionKey:m,mentionData:c}}function g(t,e,n){var o=c(t),i=o.editorState,r=o.mentionKey,s=o.mentionData;e.draft.change(i),e.mentionSuggestions.onApplyMentionToRange({mentionKey:r,mentionData:s,user:n})}Object.defineProperty(e,"__esModule",{value:!0});var p=(function(t){function e(e){var n=t.call(this,{type:"macro: @",delimiter:"@",spanProps:{className:"active-mention"}})||this;return n.mentionsOptions=e,n.onDelimiter=function(t){var e=n.options.delimiter,o=t.innerProps,i=o.text,r=o.startOffset,s=o.endOffset,a=o.input,u=r-e.length+a.length;if(i.substring(u,r)+a===e&&(0===u||" "===i.substr(u-1,1)))return{start:u,end:s,text:i.substring(u,r)+a}},n.onMacro=function(t){var e=t.innerProps,o=e.content,i=e.entityKey,r=e.blockKey,s=e.macroEndOffset,u=e.macroStartOffset,c=n.options.type,g=n.getQuery(o);return t.triggers.suggestion.updateTotalSuggestions(0),t.triggers.suggestion.updateSelectedIndex(-1),n.mentionsOptions.onMentionsQueryUpdated(g),{blockKey:r,entityKey:i,content:o,type:c,endOffset:s,startOffset:u,chrome:a.MentionSuggestionsListComponent}},n.onAutoComplete=function(t){window.setTimeout(function(){n.completeMentionImpl(t)},0)},n.getSuggestedMentionUsers=function(t){var e=t.status.macro;if(e.active){var o=t.status.mentionSuggestions,i=e.active,r=i.content;if(i.type===n.options.type){var s=n.getQuery(r);return o.userMap[s]}}},n.getSelectedUser=function(t){var e=t.status,n=e.suggestion,o=e.mentionSuggestions.users;if(n.selectedIndex!==-1&&null!==o)return o[n.selectedIndex]},n}return n.__extends(e,t),e.prototype.updateUsers=function(t){return t.kernel.compose(this.getSuggestedMentionUsers)||null},e.prototype.triggerQueryUpdateOnSuggestions=function(t){var e=t.innerProps.prevStatus.mentionSuggestions,n=e.userMap,o=e.users,i=t.status.mentionSuggestions,r=i.userMap,s=i.users;n!==r&&t.triggers.mentionSuggestions.queryUpdate(null),o!==s&&s&&t.triggers.suggestion.updateTotalSuggestions(s.length)},e.prototype.triggerQueryUpdateOnMacro=function(t){t.triggers.mentionSuggestions.queryUpdate(null)},e.prototype.completeMentionImpl=function(t){function e(t,e){return t.entityKey===e.getEntity()}var n=t.status,o=t.triggers,i=n.draft,r=n.macro,s=i.editorState.getCurrentContent();if(r.active){var a=s.getBlockForKey(r.active.blockKey),c=t.kernel.compose(this.getSelectedUser);if(c){var p=c.name.public||c.email,m=c.email,l=function(t){return!!r.active&&e(r.active,t)},d=function(t,e){return r.active&&g({editorState:i.editorState,blockKey:r.active.blockKey,identifier:m,text:p,start:t,end:e},o,c)};a.findEntityRanges(l,d)}else{var f=r.active.content.substring(this.options.delimiter.length);if(u.parseEmail(f)&&!this.mentionsOptions.disableEmailMention){var l=function(t){return!!r.active&&e(r.active,t)},d=function(t,e){return r.active&&g({editorState:i.editorState,blockKey:r.active.blockKey,identifier:f,text:f,start:t,end:e},o,c)};a.findEntityRanges(l,d)}}}},e.prototype.getQuery=function(t){var e=this.options.delimiter;return 0===t.indexOf(e)?t.substring(e.length):t},n.__decorate([o.plug(i.into.mentionSuggestions.on.queryUpdate.update.users)],e.prototype,"updateUsers",null),n.__decorate([o.plug(i.into.mentionSuggestions)],e.prototype,"triggerQueryUpdateOnSuggestions",null),n.__decorate([o.plug(i.into.macro.on.update)],e.prototype,"triggerQueryUpdateOnMacro",null),e})(s.MacroLayer);e.MentionsMacroLayer=p,e.createMentionEntity=c,e.applyMentionToRange=g});
//# sourceMappingURL=mentions_macro.min.js-vflTLTAS6.map