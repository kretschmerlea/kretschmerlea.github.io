define(["require","exports","tslib","react","external/react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/css","external/classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","modules/clean/react_format","external/lodash","modules/constants/file_viewer","spectrum_comments/comment","spectrum_comments/comment_editor","spectrum_comments/comment_stream","spectrum_comments/coachmark_location","spectrum_comments/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/onboarding","modules/clean/react/comments2/components/coachmark","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/components/util","modules/clean/react/comments2/util","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/react/comments2/data/mentions_api","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions","modules/clean/react/comments2/components/comments_more_option_manager"],function(e,t,n,o,a,i,r,s,m,l,c,d,p,u,_,g,h,f,v,b,w,T,y,E,C,M,S,A,O,P,I,k,D,U,x,N,V){"use strict";function R(e,t){return void 0===t&&(t=1),e===D.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[{page:t,x:0,y:0,width:1,height:1}]}:{type:"image",region:{x:0,y:0,width:1,height:1}}}function F(e){var t=e.currentPageIndex,a=void 0===t?0:t,i=e.disabledTimeCodeTooltipComponent,r=e.playerCurrentTime,s=void 0===r?0:r,m=e.pendingNumberedAnnotation,l=e.playerIntegrationEnabled,c=e.previewType,d=e.upsellTooltipComponent;if(c===D.PreviewType.Audio||c===D.PreviewType.Video){var p=void 0;d?p=d:l||(p=i);var u=c===D.PreviewType.Audio?"audio":"video";return o.default.createElement(g.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:u,time:s},tooltipComponent:p}))}return c===D.PreviewType.SsrDoc||c===D.PreviewType.Image?o.default.createElement(g.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:R(c,a+1),pendingAnnotation:m})):o.default.createElement(g.CommentEditor,n.__assign({},e))}Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),a=n.__importStar(a),r=n.__importStar(r),m=n.__importDefault(m),p=n.__importStar(p),P=n.__importStar(P),I=n.__importStar(I);var L=["image_preview_surface","document_preview_surface","how_to_at_mention_comments_pane_surface"],K=function(e){var t=e.children,n=e.markOnboarded,a=e.playerIntegrationEnabled,i=e.previewType,r=e.showOnboarding,s=a?"target-annotation":"target-mention",m=i!==D.PreviewType.Image&&i!==D.PreviewType.SsrDoc;return o.default.createElement(g.CoachMarkContainer,{className:s},t,m&&r&&o.default.createElement(w.CoachMark,{markOnboarded:n,playerIntegrationEnabled:a,previewType:i}))},q=(function(t){function a(a){var s=t.call(this,a)||this;return s.mentionsQueryId=0,s.onCommentStreamRef=function(e){return s.commentStream=e},s.updateMentionsMatches=function(e){s.setState({mentionsMatches:e})},s.logMentionsQueryCompletedPerf=function(e){var t=I.mentionsQueryCompleted();s.props.dispatch(A.Actions.logPerfEvent(t,e))},s.onMentionsQueryUpdated=function(e){if(e){var t=++s.mentionsQueryId;s.mentionsApi.query(e,s.updateMentionsMatches,I.withTiming(s.updateMentionsMatches,function(e){s.mentionsQueryId===t&&s.logMentionsQueryCompletedPerf(e)}))}else""===e&&s.updateMentionsMatches(s.mentionsApi.getMatchesWithStarterSuggestions());s.props.dispatch(A.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},s.onPostSuccess=function(e,t){e.metadata&&e.metadata.some(function(e){return"mention"===e.type})&&N.SharingActions.listMembers({user:t,contentId:s.props.stream.id,isFolder:!1,url:s.props.stream.linkUrl,includeSeenState:!1})},s.showEmailVerifyModal=function(e){if(!s.props.hasShownAnyModalVariant||e!==M.ShowModalReason.EditorFocus){s.props.dispatch(A.Actions.markModalVariantShown(M.ModalVariant.EmailVerifyModal)),s.props.dispatch(A.Actions.logEvent("email_verify_modal_shown"));var t=function(){s.props.dispatch(A.Actions.logEvent("email_verify_flow_completed"))};i.EmailVerification.get_for_user(s.props.viewer).show_verify_modal(t,r.ADD_COMMENT)}},s.showSignUpModal=function(t){if((!s.props.hasShownAnyModalVariant||t!==M.ShowModalReason.EditorFocus)&&u.SHARED_LINK_REACT_AUTH_MODAL){var a=function(){return n.__awaiter(s,void 0,void 0,function(){var t,a,i,r;return n.__generator(this,function(s){switch(s.label){case 0:return[4,Promise.all([new Promise(function(t,n){e(["modules/clean/react/modal"],t,n)}).then(n.__importStar),new Promise(function(t,n){e(["modules/clean/auth/login_or_register/modal"],t,n)}).then(n.__importStar),new Promise(function(t,n){e(["modules/core/browser"],t,n)}).then(n.__importStar)])];case 1:return t=s.sent(),a=t[0].Modal,i=t[1].LoginOrRegisterModal,r=t[2],a.showInstance(o.default.createElement(i,{commentParams:{fileActivityKey:"asdf",variant:c.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:c.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return r.reload()},onCancel:p.noop,signup_tag:"comments_shmodel_modal_register"})),[2]}})})};s.props.dispatch(A.Actions.markModalVariantShown(M.ModalVariant.SignUpModal)),a()}},s.dismissImagePreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("image_preview_surface")},s.dismissDocumentPreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("document_preview_surface")},s.dismissHowToAtMentionOnoarding=function(){s.dismissOnboarding(),s.markOnboarded("how_to_at_mention_comments_pane_surface")},s.createComment=function(e){switch(s.props.previewType){case D.PreviewType.Video:case D.PreviewType.Audio:return o.default.createElement(_.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:s.props.playerIntegrationEnabled}));case D.PreviewType.Image:case D.PreviewType.SsrDoc:return o.default.createElement(_.NumberedComment,n.__assign({},e));default:return o.default.createElement(_.Comment,n.__assign({},e))}},s.createEditor=function(e){var t=s.props,a=t.currentPageIndex,i=t.pendingNumberedAnnotation,r=t.playerCurrentTime,m=t.playerIntegrationEnabled,l=t.previewType,c=t.showOnboarding,d=t.upsellTooltipVariant,p=d?s.createUpsellTooltip:void 0;return o.default.createElement(K,{markOnboarded:s.markOnboarded,playerIntegrationEnabled:m,previewType:l,showOnboarding:c},o.default.createElement(F,n.__assign({},e,{disabledTimeCodeTooltipComponent:s.createDisabledTimeCodeTooltip,upsellTooltipComponent:p,pendingNumberedAnnotation:i,currentPageIndex:a,playerIntegrationEnabled:m,playerCurrentTime:r,previewType:l})))},s.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(x.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:s.onDisabledTooltipLearnMoreClick,onShow:s.onDisabledTooltipShow}))},s.createUpsellTooltip=function(e){return o.default.createElement(x.UpsellTooltip,n.__assign({},e,{onClick:s.onUpsellTooltipClick,onDismiss:s.onUpsellTooltipDismiss,onShow:s.onUpsellTooltipShow,variant:s.props.upsellTooltipVariant,showUpsellExperiment:!s.props.collapsed&&s.props.showUpsellExperiment}))},s.onDisabledTooltipLearnMoreClick=function(){return s.props.dispatch(A.Actions.logEvent("time_based_tooltip_learn_more_click"))},s.onDisabledTooltipShow=function(){return s.props.dispatch(A.Actions.logEvent("time_based_tooltip_learn_more_view"))},s.onUpsellTooltipClick=function(){s.dismissUpsell(),s.props.dispatch(A.Actions.logEvent("time_based_tooltip_upgrade_click"))},s.onUpsellTooltipDismiss=function(){s.dismissUpsell(),s.props.dispatch(A.Actions.logEvent("time_based_tooltip_upgrade_dismiss"))},s.onUpsellTooltipShow=function(){return s.props.dispatch(A.Actions.logEvent("time_based_tooltip_upgrade_view"))},s.markOnboarded=function(e){s.props.dispatch(A.Actions.markOnboarded(e))},s.dismissOnboarding=function(){s.props.dispatch(A.Actions.dismissOnboarding(null))},s.mentionsApi=k.mentionsApi(a.viewer),s.state={mentionsMatches:s.mentionsApi.cache},s}return n.__extends(a,t),a.prototype.componentDidMount=function(){var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,a=+new Date;t(A.Actions.logEvent("show_comments")),t(A.Actions.logSimplePerfEvent("stream_displayed_ms",a-(o.listCompleteTime||0))),t(A.Actions.logSimplePerfEvent("comment_editor_tti_ms",a-(o.setContextTime||0))),n&&t(A.Actions.logEvent("sidebar_onboarding_shown"))},a.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,n=e.showOnboarding,o=this.props,a=o.showOnboarding,i=o.dispatch,r=o.requestEditorFocus;!n&&a&&i(A.Actions.logEvent("sidebar_onboarding_shown")),!t&&r&&(this.commentStream.focusPrimaryEditor(),i(A.Actions.fulfillEditorFocusRequest()))},Object.defineProperty(a.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return p.difference(this.props.relevantOnboardingKeys,L)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imagePdfCoachmarkData",{get:function(){var e=this,t=this.props,a=t.showOnboarding,i=t.relevantOnboardingKeys,r=l._("Animation of annotating a file",{comment:"This is alt text for an animated gif"}),s=a&&p.head(p.intersection(L,i)),m={title:o.default.createElement("h2",{className:"sc-coachmark-title"}),body:o.default.createElement("p",null)};switch(s){case"document_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissDocumentPreviewSurfaceOnboarding}),o.default.createElement(E.Comments2OnboardingImage,{fileNamePrefix:"02_Comments2_PDFComments","aria-label":r}),d.reactFormat(l._("<title>Call it out</title> <body>Select an area on the file to highlight and comment.</body>"),m))}};case"image_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissImagePreviewSurfaceOnboarding}),o.default.createElement(E.Comments2OnboardingImage,{fileNamePrefix:"01_Comments2_ImageComment","aria-label":r}),d.reactFormat(l._("<title>Call it out</title> <body>Select an area on the image to highlight and comment.</body>"),m))}};case"how_to_at_mention_comments_pane_surface":return{location:f.CoachmarkLocations.ABOVE_COMMENT_STREAM,target:f.CoachmarkTargets.MAIN_EDITOR_MENTION_BUTTON,component:function(t){return o.default.createElement(T.CommentsCoachmark,n.__assign({},t,{onClose:e.dismissHowToAtMentionOnoarding}),o.default.createElement(E.Comments2OnboardingImage,{fileNamePrefix:"03_Comments_AtMentions_v1","aria-label":l._("Animation of mentioning a user",{comment:"This is alt text for an animated gif"})}),d.reactFormat(l._("<title>Get the feedback you need</title> <body>Tag someone to work together on this file.</body>"),m))}};default:return}},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return b.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!0,configurable:!0}),a.prototype.dismissUpsell=function(){var e=C.inUpsellExperiment();this.props.showUpsellExperiment?this.props.dispatch(A.Actions.dismissUpsellExperiment(void 0)):e||this.props.dispatch(A.Actions.dismissUpsellTooltip(void 0))},a.prototype.render=function(){var e,t=this.props,n=t.activeThreadId,a=t.collapsed,i=t.dispatch,r=t.editorIsEmpty,s=t.hoverThreadId,l=t.isMobile,c=t.showResolved,d=t.stream.id,p=t.threads,u=t.viewer,_=t.previewType,g=t.streamSettings,f=t.enableMoreOptionManager,b=p.filter(function(e){return c||!e.resolvedInfo});e=u?S.dbxUserToIUser(u):v.getGuestIUser();var w=_===D.PreviewType.Image||_===D.PreviewType.SsrDoc;return o.default.createElement("div",{className:m.default("comments-pane-wrapper",{"no-comment":C.isComments2Mobile()&&0===b.length,"comments-pane-wrapper-show-resolved":c,"comments-pane-wrapper-hide-resolved":!c,"comments-pane-wrapper-all-changes-saved":!p.some(function(e){return!!e.pending})})},o.default.createElement(h.CommentStream,{ref:this.onCommentStreamRef,id:d,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:l,mentionsMatches:this.state.mentionsMatches,settings:g,threads:b,user:e,activeThreadID:n,hoverThreadID:s,showUnreadPill:C.canShowUnreadPill(),localization:U.commentsMasterLocalization,collapsed:a,coachmarkData:this.imagePdfCoachmarkData,showRevisionInfo:w}),o.default.createElement(y.SidebarListener,{dispatch:i,editorIsEmpty:r}),f&&o.default.createElement(V.CommentsMoreOptionManager,null))},a})(o.default.Component);t.CommentsPaneComponent=q;var Q=a.connect(function(e){var t=P.getContext(e),n=t.stream,o=t.viewer,a=P.getData(e),i=a.perfEvents,r=a.upsellExperimentNotDismissed,s=a.upsellTooltipVariant;return{activeThreadId:P.getActivatedThreadId(e),editorIsEmpty:P.getEditorIsEmpty(e),hasShownAnyModalVariant:P.getHasShownAnyModalVariant(e),hoverThreadId:P.getHoverThreadId(e),playerCurrentTime:P.getPlayerCurrentTime(e),playerIntegrationEnabled:P.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:P.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:P.getShowOnboardingOnCommentsPane(e),showResolved:P.getShowResolved(e),canEnable:P.getCanEnable(e),isEnabled:P.getIsEnabled(e),canSubscribe:P.getCanSubscribe(e),isSubscribed:P.getIsSubscribed(e),pendingNumberedAnnotation:P.getPendingNumberedAnnotation(e),previewType:P.getPreviewTypeForCurrentFile(e),currentPageIndex:O.getCurrentPageIndex(e),showUpsellExperiment:C.inUpsellExperiment()&&r,stream:n,threads:P.getThreads(e),viewer:o,upsellTooltipVariant:s,perfEvents:i,requestEditorFocus:P.getIsEditorFocusRequested(e),streamSettings:P.getStreamSettings(e),stickers:P.getStickers(e)}})(q);t.CommentsPane=s.requireCssWithComponent(Q,["/static/js/spectrum_comments/index.web-vflhMTrz9.css","/static/css/comments2-vflI7tlMt.css","/static/css/snackbar-vflNSHCgN.css"])});
//# sourceMappingURL=comments_pane.min.js-vflTnxoh2.map