define(["require","exports","tslib","modules/clean/ajax","external/lodash","modules/core/i18n","modules/clean/web_timing_logger","modules/core/cookies","modules/core/notify","modules/core/uri","modules/clean/api_v2/transport/jquery"],function(e,t,r,n,o,i,a,s,c,u,d){"use strict";function _(e,t,n){return r.__awaiter(this,void 0,void 0,function(){var o,i,a,c,_;return r.__generator(this,function(r){switch(r.label){case 0:if(o=new d.JQueryAsyncTransport,i=new u.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),a={},a["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),a["X-Dropbox-Uid"]=e.id.toString(),c=s.Cookies.read("__Host-js_csrf"),!c)throw new Error("No CSRF cookie");return a["X-CSRF-Token"]=c,[4,o.executeRpc(i,a,JSON.stringify(n),"application/json")];case 1:return _=r.sent(),[2,{request_id:_.headers["x-dropbox-request-id"],redirect_url:_.result.redirect_url}]}})})}function l(e,t,n,o){return r.__awaiter(this,void 0,void 0,function(){var i;return r.__generator(this,function(r){switch(r.label){case 0:return i=function(){return _(e,"redirect",{action_id:t,file_id:o})},[4,m(e,t,n,o,i)];case 1:return r.sent(),[2]}})})}function m(e,t,s,u,d,_){return r.__awaiter(this,void 0,Promise,function(){function l(){return r.__awaiter(this,void 0,void 0,function(){var e;return r.__generator(this,function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,d()];case 1:return[2,t.sent()];case 2:return e=t.sent(),p=!0,[2,void 0];case 3:return[2]}})})}var m,f,h,p,w,g,v,b,x,T;return r.__generator(this,function(r){switch(r.label){case 0:return a.delete_timer("extensions_redirect_handoff"),m=a.get_timer("extensions_redirect_handoff"),m.initialize({requireTTI:!0,requireTTV:!1,url:"extensions_redirect_handoff"}),f="action_redirect_"+Math.random().toString(16).substring(2),h=window.open("",f,_),h&&(h.document.open("text/html","replace"),h.document.write("<html><head><title>"+o.escape(s)+"</title></head></html>"),h.document.close()),p=!1,w=new Promise(function(r){n.SilentBackgroundRequest({url:"/aa/loading",subject_user:e.id,data:{file_id:u,action_id:t},success:function(e){!p&&h?(h.document.open("text/html","replace"),h.document.write(e),h.document.close(),h.document.title=s,setTimeout(r,1500)):r()},error:function(){r()}})}),[4,Promise.all([w,l()])];case 1:return g=r.sent(),v=g[1],b=v&&v.redirect_url||"/aa/error",h?h.location.replace(b):(x=window.open(b,"_blank",_),x||(T=s,c.Notify.error(i._("Failed to open %(app_name)s").format({app_name:T})))),v&&v.request_id&&(m.markTimeToInteractive(),m.end(v.request_id)),[2,v]}})})}Object.defineProperty(t,"__esModule",{value:!0}),n=r.__importStar(n),o=r.__importStar(o);t.fetchUrl=_,t.redirectToAction=l,t.showLoadingPageAndDoRedirect=m});
//# sourceMappingURL=redirect.min.js-vflM8V0TK.map